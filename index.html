<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PLERNTS</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="jquery-3.2.1.min.js"></script>
</head>
<body>

<svg width="600" height="600" font-family="sans-serif" font-size="10" text-anchor="middle"></svg>

<script>

function plant(length, theta) {
  if (typeof theta === 'undefined') theta = -25 * Math.PI / 180
  return function(acc, code) {
    switch (code) {
    case 'X': break
    case 'F':
      acc.state.x -= length * Math.cos(acc.state.theta)
      acc.state.y -= length * Math.sin(acc.state.theta)
      acc.svg.push("L" + acc.state.x + "," + acc.state.y)
      break

    case '+':
      acc.state.theta += theta
      break

    case '-':
      acc.state.theta -= theta
      break

    case '[':
      acc.stack.push($.extend({}, acc.state))
      break

    case ']':
      acc.state = acc.stack.pop()
      acc.svg.push("M" + acc.state.x + "," + acc.state.y)
      break
    }
    return acc
  }
}

function linit(x, y) {
  var state = { x:x, y:y, theta:Math.PI/2 }
  var svg = [ "M" + x + "," + y ]
  return { state:state, svg:svg, stack:[] }
}

function ldraw(state, color, target) {
  if (typeof target === 'undefined') target = "svg"
  d3.select(target)
    .append("path")
    .attr("stroke", color)
    .attr("stroke-width",1.5)
    .attr("fill","none")
    .attr("d", state.svg.join(" "))
}

function lrender(origin, color, sequence, handler) {
  var state = linit(origin.x, origin.y)
  state = sequence.reduce(handler, state)
  ldraw(state, color)
  return state
}

var step = 5.0
var angle = 0.396
var width = height = 600
var colors = ["#367132", "#57A71C", "#71C70C", "#ABBE55", "#B1DE75", "50F71E", "#57A515", "#7AB005", "#5ECC05"]

$.get("http://localhost:5000/plants", function(data, status){
        var plants = data['results'].slice(0, 20)
        plants.forEach(function(p) {
            var pos = Math.random() * (width - 100) + 100
            var col = colors[Math.floor(Math.random() * colors.length)]
            lrender({ x:pos, y:(height - 100) }, col, p.split(''), plant(step, angle))
        })
    });

</script>
</body>
</html>